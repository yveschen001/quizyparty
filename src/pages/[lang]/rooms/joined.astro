---
import { setupServerI18n } from '../../../lib/server-i18n'
import SeoMeta from '../../../components/SeoMeta.astro'
import AppHeader from '../../../components/layout/AppHeader.astro'
import '../../../styles/base.css'

const { lang, serverT } = await setupServerI18n(Astro.params.lang)
const title = serverT('profile.sections.participations')
const desc = serverT('profile.sections.participations')

export const prerender = false
const siteOrigin =
  (Astro.site && Astro.site.origin) || import.meta.env.SITE || 'https://quizyparty.com'
const path = Astro.url.pathname
---

<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <SeoMeta lang={lang} title={title} description={desc} path={path} siteOrigin={siteOrigin} />
  </head>
  <body>
    <a href="#main" class="sr-only">{serverT('a11y.skipToContent')}</a>
    <AppHeader lang={lang} serverT={serverT} />
    <main
      id="main"
      class="container"
      style="display:grid;gap:16px;padding-top:24px;padding-bottom:48px"
    >
      <nav aria-label={serverT('common.breadcrumbs')} class="caption" style="display:flex;gap:8px">
        <a href={`/${lang}/profile`} class="caption" aria-label={serverT('profile.title')}
          >{serverT('profile.title')}</a
        >
        <span aria-hidden="true">/</span>
        <span class="caption">{title}</span>
      </nav>
      <h1 class="h1" style="margin:0">{title}</h1>
      <div id="message" style="min-height:1.1em;font-size:0.9rem"></div>
      <div id="list" style="display:grid;gap:12px"></div>
    </main>
    <script type="module" src="/js/i18n.js"></script>
    <script type="module">
      ;(async function () {
        await import('/js/i18n.js')
        const lang = document.documentElement.getAttribute('lang') || 'en'
        let fmt = null
        try {
          fmt = await import('/src/utils/format.ts')
        } catch (e) {}
        const message = document.getElementById('message')
        const list = document.getElementById('list')
        function showMessage(text, isError) {
          if (!message) return
          message.textContent = text || ''
          message.style.color = isError ? '#d00' : '#059669'
        }
        function formatAccuracy(value) {
          if (fmt && fmt.formatPercent) return fmt.formatPercent(Number(value || 0), lang, 1)
          const percent = Math.round(Number(value || 0) * 1000) / 10
          return percent.toFixed(1) + '%'
        }
        function formatDate(timestamp) {
          if (fmt && fmt.formatDate) return fmt.formatDate(timestamp, lang, { year: 'numeric', month: 'short', day: 'numeric' })
          if (!timestamp) return ''
          const d = new Date(timestamp)
          if (!d.getTime()) return ''
          try {
            return d.toLocaleString(lang, { year: 'numeric', month: 'short', day: 'numeric' })
          } catch (e) {
            return d.toLocaleString()
          }
        }
        async function loadParticipations() {
          if (!list) return
          list.innerHTML =
            '<p style=\"padding:16px;text-align:center;opacity:0.6\">' +
            window.t('room.loading') +
            '</p>'
          try {
            const res = await fetch('/api/scores/rooms?limit=100', { credentials: 'include' })
            if (res.status === 401) {
              showMessage(window.t('profile.notLoggedIn'), true)
              list.innerHTML = ''
              return
            }
            const json = await res.json()
            const items = Array.isArray(json.rooms) ? json.rooms : []
            if (!items.length) {
              list.innerHTML =
                '<p style=\"padding:16px;text-align:center;opacity:0.6\">' +
                window.t('profile.participations.empty') +
                '</p>'
              return
            }
            list.innerHTML = ''
            for (let i = 0; i < items.length; i += 1) {
              const item = items[i]
              if (!item) continue
              const card = document.createElement('div')
              card.className = 'card'
              card.style.padding = '16px'
              card.style.display = 'grid'
              card.style.gap = '8px'
              const title = document.createElement('div')
              title.style.display = 'flex'
              title.style.justifyContent = 'space-between'
              title.style.alignItems = 'center'
              title.style.gap = '8px'
              const t1 = document.createElement('div')
              t1.style.fontWeight = '700'
              t1.textContent = item.roomTitle || window.t('questionSets.untitled')
              const t2 = document.createElement('span')
              t2.style.fontSize = '0.85rem'
              t2.style.opacity = '0.65'
              t2.textContent = formatDate(item.lastAnsweredAt)
              title.appendChild(t1)
              title.appendChild(t2)
              card.appendChild(title)
              const meta = document.createElement('div')
              meta.style.fontSize = '0.9rem'
              meta.style.opacity = '0.75'
              meta.textContent =
                window
                  .t('profile.participations.total')
                  .replace('{value}', String(item.totalAnswered || 0)) +
                ' Â· ' +
                window
                  .t('profile.participations.accuracy')
                  .replace('{value}', formatAccuracy(item.accuracy || 0))
              card.appendChild(meta)
              const actions = document.createElement('div')
              actions.style.display = 'flex'
              actions.style.gap = '8px'
              actions.style.flexWrap = 'wrap'
              const replay = document.createElement('a')
              replay.className = 'btn'
              replay.style.fontSize = '0.85rem'
              replay.href = '/' + lang + '/room/' + encodeURIComponent(item.roomId)
              replay.textContent = window.t('profile.history.playAgain')
              replay.setAttribute('aria-label', window.t('profile.history.playAgain'))
              actions.appendChild(replay)
              card.appendChild(actions)
              list.appendChild(card)
            }
          } catch (e) {
            console.error('[rooms/joined] load failed', e)
            showMessage(window.t('errors.networkError'), true)
          }
        }
        await loadParticipations()
      })()
    </script>
  </body>
</html>
