---
import { setupServerI18n } from '../../../lib/server-i18n'
import SeoMeta from '../../../components/SeoMeta.astro'
import AppHeader from '../../../components/layout/AppHeader.astro'
import '../../../styles/base.css'
import EmptyState from '../../../components/ui/EmptyState.astro'
import LoadingState from '../../../components/ui/LoadingState.astro'
import ErrorState from '../../../components/ui/ErrorState.astro'

const { lang, serverT } = await setupServerI18n(Astro.params.lang)
const title = serverT('profile.sections.participations')
const desc = serverT('profile.sections.participations')
const featureV3 = (import.meta.env.PUBLIC_FEATURE_QP_V3 ?? 'true') !== 'false'

export const prerender = false
const siteOrigin =
  (Astro.site && Astro.site.origin) || (import.meta.env.SITE ?? 'https://quizyparty.com')
const path = Astro.url.pathname
---

<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <SeoMeta lang={lang} title={title} description={desc} path={path} siteOrigin={siteOrigin} />
  </head>
  <body data-feature-v3={featureV3 ? 'true' : 'false'}>
    <a href="#main" class="sr-only">{serverT('a11y.skipToContent')}</a>
    <AppHeader lang={lang} serverT={serverT} />
    <main
      id="main"
      class:list={['container', featureV3 ? 'stack-lg' : 'legacy-profile-main']}
    >
      <div id="joined-controls" class="mb-3" style="position:sticky;top:0;z-index:5;background:var(--surface,#fff)"></div>
      <div id="joined-pager-top" class="mb-2"></div>
      <nav aria-label={serverT('common.breadcrumbs')} class="caption breadcrumb">
        <a
          href={`/${lang}/profile`}
          class="caption"
          aria-label={serverT('profile.title')}
          >{serverT('profile.title')}</a
        >
        <span aria-hidden="true">/</span>
        <span class="caption">{title}</span>
      </nav>
      <h1 id="joined-title" class="h1 no-margin">{title}</h1>
      <div class="mb-2" style="display:flex;gap:8px;align-items:center">
        <input
          id="joined-search"
          type="search"
          placeholder={serverT('questionSets.library.searchPlaceholder')}
          style="flex:1;min-width:220px;padding:9px 12px;border:1px solid #e5e7eb;border-radius:10px"
        />
      </div>
      <div id="message" class="status-text" role="status" aria-live="polite"></div>
      <LoadingState id="joined-loading" lang={lang} serverT={serverT} titleKey="common.loading" />
      <EmptyState
        id="joined-empty"
        lang={lang}
        serverT={serverT}
        titleKey="common.empty.joined.title"
        descKey="common.empty.joined.desc"
        actionHref={`/${lang}/`}
        actionKey="common.empty.joined.action"
      />
      <ErrorState
        id="joined-error"
        lang={lang}
        serverT={serverT}
        titleKey="common.error.title"
        descKey="common.error.desc"
        retryLabelKey="common.error.retry"
        onRetryId="joined-retry"
      />
      <div id="list" class={featureV3 ? 'stack' : 'legacy-section'} role="list"></div>
    <div id="joined-pager-bottom" class="mt-3"></div>
</main>
    <script type="module" src="/js/i18n.js"></script>
    <script src="/js/i18n-compat.js" is:inline></script>
    <script src="/js/qp-cache.js" is:inline></script>
    <script src="/js/rooms-pagination.js" is:inline></script>
    <script src="/js/room-card-template.js" is:inline></script>
    <script type="module">
      ;(async function () {
        await import('/js/i18n.js')
        const lang = document.documentElement.getAttribute('lang') || 'en'
        const featureV3 =
          document.body && document.body.dataset
            ? document.body.dataset.featureV3 === 'true'
            : false
        let fmt = null
        try {
          fmt = await import('/src/utils/format.ts')
        } catch (e) {}
        const message = document.getElementById('message')
        const list = document.getElementById('list')
        const searchInput = document.getElementById('joined-search')
        function showMessage(text, isError) {
          if (!message) return
          if (!text) {
            message.innerHTML = ''
            message.style.color = ''
            return
          }
          if (featureV3) {
            message.innerHTML =
              '<div class="card text-center ' +
              (isError ? 'text-danger' : '') +
              '">' +
              text +
              '</div>'
            message.style.color = ''
            return
          }
          message.textContent = text || ''
          message.style.color = isError ? '#d00' : '#059669'
        }
        function formatNumber(value) {
          if (fmt && fmt.formatNumber) return fmt.formatNumber(value || 0, lang)
          try {
            return new Intl.NumberFormat(lang).format(value || 0)
          } catch (e) {
            return String(value || 0)
          }
        }

        function formatAccuracy(value) {
          if (fmt && fmt.formatPercent) return fmt.formatPercent(Number(value || 0), lang, 1)
          const percent = Math.round(Number(value || 0) * 1000) / 10
          return percent.toFixed(1) + '%'
        }
        function formatDate(timestamp) {
          if (fmt && fmt.formatDate)
            return fmt.formatDate(timestamp, lang, { year: 'numeric', month: 'short', day: 'numeric' })
          if (!timestamp) return ''
          const d = new Date(timestamp)
          if (!d.getTime()) return ''
          try {
            return new Intl.DateTimeFormat(lang, {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            }).format(d)
          } catch (e) {
            return d.toISOString()
          }
        }
        const joinedLoading = document.getElementById('joined-loading')
        const joinedEmpty = document.getElementById('joined-empty')
        function toggle(el, show) {
          if (!el) return
          el.style.display = show ? '' : 'none'
        }
        function renderSkeleton() {
          if (!list) return
          list.innerHTML = ''
          toggle(joinedEmpty, false)
          toggle(joinedLoading, true)
          if (featureV3) {
            for (let i = 0; i < 3; i += 1) {
              const skeleton = document.createElement('div')
              skeleton.className = 'card card-skeleton'
              skeleton.style.minHeight = '104px'
              skeleton.setAttribute('role', 'listitem')
              list.appendChild(skeleton)
            }
            return
          }
          list.innerHTML =
            '<p style="padding:16px;text-align:center;opacity:0.6">' +
            window.t('room.loading') +
            '</p>'
        }
        function renderEmpty() {
          if (!list) return
          const ctaLabel = window.t('profile.participations.cta')
          const ctaHref = '/' + lang + '/'
          list.innerHTML = ''
          toggle(joinedLoading, false)
          toggle(joinedEmpty, true)
          if (featureV3) {
            const wrapper = document.createElement('div')
            wrapper.className = 'card stack text-center'
            wrapper.setAttribute('role', 'listitem')
            const text = document.createElement('p')
            text.className = 'p text-muted'
            text.textContent = window.t('profile.participations.empty')
            const link = document.createElement('a')
            link.className = 'btn btn-primary'
            link.href = ctaHref
            link.textContent = ctaLabel
            wrapper.appendChild(text)
            wrapper.appendChild(link)
            list.appendChild(wrapper)
            return
          }
          const legacyWrapper = document.createElement('div')
          legacyWrapper.style.padding = '16px'
          legacyWrapper.style.textAlign = 'center'
          legacyWrapper.style.opacity = '0.6'
          const legacyText = document.createElement('p')
          legacyText.style.marginBottom = '12px'
          legacyText.textContent = window.t('profile.participations.empty')
          const legacyLink = document.createElement('a')
          legacyLink.className = 'btn'
          legacyLink.href = ctaHref
          legacyLink.textContent = ctaLabel
          legacyWrapper.appendChild(legacyText)
          legacyWrapper.appendChild(legacyLink)
          list.appendChild(legacyWrapper)
        }
        function getSortFromUrl(){ try { const q=new URLSearchParams(location.search); return q.get('sort')||'lastPlayed' } catch { return 'lastPlayed' } }
        function getQueryFromUrl(){ try { const q=new URLSearchParams(location.search); return q.get('q')||'' } catch { return '' } }
        function setQueryInUrl(v){ try { const u=new URL(location.href); if(v){u.searchParams.set('q',v)} else {u.searchParams.delete('q')} history.replaceState(null,'',u.toString()) } catch {} }
        if (searchInput){
          try { const init = getQueryFromUrl(); if (init) searchInput.value = init } catch {}
          let t=null
          searchInput.addEventListener('input', function(){
            if (t) clearTimeout(t)
            t=setTimeout(function(){ setQueryInUrl(searchInput.value||''); loadParticipations() }, 250)
          })
          searchInput.addEventListener('keydown', function(e){ if (e.key==='Enter'){ setQueryInUrl(searchInput.value||''); loadParticipations() } })
        }

        async function loadParticipations() {
          if (!list) return
          renderSkeleton()
          try {
            const res = await fetch('/api/scores/rooms?limit=100', { credentials: 'include' })
            if (res.status === 401) {
              showMessage(window.t('profile.notLoggedIn'), true)
              list.innerHTML = ''
              return
            }
            const json = await res.json()
            let items = Array.isArray(json.rooms) ? json.rooms : []
            // 依 URL 參數進行排序 + 關鍵字過濾
            try {
              const q = new URLSearchParams(location.search)
              const sort = q.get('sort') || 'lastPlayed'
              const kw = (q.get('q') || '').trim().toLowerCase()
              if (kw) {
                items = items.filter(function (it) {
                  return String(it && it.roomTitle ? it.roomTitle : '').toLowerCase().indexOf(kw) >= 0
                })
              }
              if (sort === 'answered') {
                items.sort(function(a,b){ return (Number(b?.totalAnswered||0) - Number(a?.totalAnswered||0)) })
              } else if (sort === 'accuracy') {
                function getAcc(x){ return typeof x?.accuracy==='number'?x.accuracy:(typeof x?.correctRate==='number'?x.correctRate:0) }
                items.sort(function(a,b){ return getAcc(b) - getAcc(a) })
              } else if (sort === 'title') {
                items.sort(function(a,b){ return String(a?.roomTitle||'').localeCompare(String(b?.roomTitle||'')) })
              } else if (sort === 'updated') {
                items.sort(function(a,b){
                  const aTime = new Date(a?.updatedAt||a?.lastAnsweredAt||0).getTime()
                  const bTime = new Date(b?.updatedAt||b?.lastAnsweredAt||0).getTime()
                  return bTime - aTime
                })
              } else {
                items.sort(function (a, b) {
                  const aTime = new Date(a && a.lastAnsweredAt ? a.lastAnsweredAt : 0).getTime()
                  const bTime = new Date(b && b.lastAnsweredAt ? b.lastAnsweredAt : 0).getTime()
                  return bTime - aTime
                })
              }
            } catch (e) {}
            if (!items.length) {
              renderEmpty()
              return
            }
            showMessage('', false)
            list.innerHTML = ''
            for (let i = 0; i < items.length; i += 1) {
              const item = items[i]
              if (!item) continue
              const card = document.createElement('div')
              card.setAttribute('role', 'listitem')
              card.setAttribute('data-testid', 'room-card')
              if (item && item.roomTitle) {
                card.setAttribute('aria-label', String(item.roomTitle))
              }
              // 使用共用模板生成卡片 HTML（保留原資料來源與事件流程）
              const acc =
                typeof item.accuracy === 'number'
                  ? item.accuracy
                  : typeof item.correctRate === 'number'
                  ? item.correctRate
                  : undefined
              const href = '/' + lang + '/room/' + encodeURIComponent(item.roomId || '')
              card.innerHTML = RoomCardTemplate.roomCardHTML({
                kind: 'joined',
                status: 'public',
                id: item.roomId || '',
                title: item.roomTitle || window.t('questionSets.untitled'),
                updatedAt: item.lastAnsweredAt,
                lastPlayedAt: item.lastAnsweredAt,
                answered: item.totalAnswered,
                accuracy: acc,
                href: href,
                lang: lang
              })
              list.appendChild(card)
            }
          } catch (e) {
            console.error('[rooms/joined] load failed', e)
            try {
              const err = document.getElementById('joined-error')
              const retry = document.getElementById('joined-retry')
              toggle(joinedLoading, false)
              toggle(joinedEmpty, false)
              toggle(err, true)
              if (retry) {
                retry.onclick = function () {
                  toggle(err, false)
                  loadParticipations()
                }
              }
            } catch (e) {
              showMessage(window.t('errors.networkError'), true)
            }
          }
        }
        await loadParticipations()
        try {
          const titleEl = document.getElementById('joined-title')
          if (titleEl) titleEl.textContent = window.t('profile.sections.participations')
        } catch (e) {}
        if (list) {
          list.addEventListener('click', function (event) {
            const link = event.target && event.target.closest('[data-action="replay"]')
            if (!link) return
            const href = link.getAttribute('href')
            if (!href) return
            event.preventDefault()
            link.setAttribute('aria-busy', 'true')
            fetch(href, { method: 'HEAD', credentials: 'include', redirect: 'manual' })
              .then(function (res) {
                if (res.ok || (res.status >= 300 && res.status < 400)) {
                  window.location.href = href
                  return
                }
                showMessage(window.t('errors.networkError'), true)
                link.removeAttribute('aria-busy')
              })
              .catch(function (error) {
                console.error('[rooms/joined] replay failed', error)
                showMessage(window.t('errors.networkError'), true)
                link.removeAttribute('aria-busy')
              })
          })
        }
      })()
    </script>
  </body>
</html>
