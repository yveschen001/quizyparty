---
import { setupServerI18n } from '../../lib/server-i18n'
import '../../styles/base.css'

const { lang, serverT } = await setupServerI18n(Astro.params.lang)
const title = serverT('myRooms.title')
const desc = serverT('profile.desc')

export const prerender = false
const siteOrigin = (Astro.site && Astro.site.origin) || import.meta.env.SITE || 'https://quizyparty.com'
const path = Astro.url.pathname
---
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={desc} />
    <link rel="canonical" href={`${siteOrigin}${path}`} />
  </head>
  <body>
    <a href="#main" class="sr-only">{serverT('a11y.skipToContent')}</a>
    <header class="navbar">
      <div class="container inner">
        <a href={`/${lang}/`}>{serverT('nav.home')}</a>
        <nav style="display:flex;gap:12px;align-items:center">
          <button id="auth-btn" class="btn" style="font-size:0.875rem;display:none">{serverT('auth.login')}</button>
          <div id="user-info" style="display:none;position:relative;align-items:center">
            <button id="user-menu-trigger" data-role="menu-trigger" type="button" style="display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:0.875rem;cursor:pointer">
              <img id="user-avatar" data-role="avatar" src="" alt="" style="width:28px;height:28px;border-radius:50%;object-fit:cover" />
              <span id="user-name" data-role="name" style="max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></span>
              <span data-role="menu-caret" aria-hidden="true" style="font-size:0.7rem;color:#6b7280">â–¼</span>
            </button>
            <div id="user-menu" data-role="menu-panel" style="display:none;position:absolute;right:0;top:calc(100% + 8px);min-width:260px;padding:16px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 18px 38px rgba(15,23,42,0.16);z-index:40"></div>
          </div>
        </nav>
      </div>
    </header>
    <main id="main" class="container" style="padding-top:32px;padding-bottom:64px">
      <section style="display:grid;gap:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
          <div>
            <h1 style="margin:0">{title}</h1>
            <p style="margin:4px 0 0;font-size:0.95rem;opacity:0.7">{serverT('profile.desc')}</p>
          </div>
          <a id="myrooms-create-btn" class="btn btn-primary" href={`/${lang}/create-room`} style="font-size:0.9rem">{serverT('myRooms.create')}</a>
        </div>
        <div role="tablist" aria-label={serverT('myRooms.title')} style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" data-status="published" type="button" aria-pressed="true">{serverT('myRooms.published')}</button>
          <button class="btn" data-status="draft" type="button" aria-pressed="false">{serverT('myRooms.drafts')}</button>
        </div>
        <div id="myrooms-message" style="min-height:1.2em;font-size:0.9rem"></div>
        <div id="myrooms-list" style="display:grid;gap:12px"></div>
        <div id="myrooms-pagination" style="display:none;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px"></div>
      </section>
    </main>
    <script type="module" src="/js/i18n.js"></script>
    <script src="/js/room-templates.js" is:inline></script>
    <script type="module">
      (async function() {
        await import('/js/i18n.js')
        const { setupUserMenu } = await import('/js/user-menu.js')
        const { setupRoomsManager } = await import('/js/rooms-manager.js')
        const lang = document.documentElement.getAttribute('lang') || 'en'
        const authBtn = document.getElementById('auth-btn')
        const userInfo = document.getElementById('user-info')
        const listEl = document.getElementById('myrooms-list')
        const paginationEl = document.getElementById('myrooms-pagination')
        const messageEl = document.getElementById('myrooms-message')
        const tabButtons = Array.prototype.slice.call(document.querySelectorAll('[data-status]'))

        function showMessage(text, isError) {
          if (!messageEl) return
          if (!text) {
            messageEl.textContent = ''
            return
          }
          messageEl.textContent = text
          messageEl.style.color = isError ? '#d00' : '#059669'
        }

        const userMenu = setupUserMenu({
          lang: lang,
          t: function(key) { return window.t(key) },
          profileUrl: function(targetLang) { return '/' + targetLang + '/profile' },
          aboutUrl: function(targetLang) { return '/' + targetLang + '/about' },
          privacyUrl: function() { return 'https://quizyparty.com/privacy' },
          termsUrl: function() { return 'https://quizyparty.com/terms' },
          onLogout: async function() {
            try {
              await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
            } catch (e) {
              console.error('Logout failed', e)
            }
            window.location.reload()
          }
        })

        async function checkAuth() {
          try {
            const res = await fetch('/api/auth/me', { credentials: 'include' })
            if (!res.ok) {
              if (authBtn) authBtn.style.display = 'block'
              if (userInfo) userInfo.style.display = 'none'
              if (userMenu && typeof userMenu.clearUser === 'function') {
                userMenu.clearUser()
              }
              listEl.innerHTML = '<p style="padding:16px;text-align:center;opacity:0.6">' + window.t('profile.notLoggedIn') + '</p>'
              return null
            }
            const json = await res.json()
            if (json && json.authenticated && json.user) {
              if (authBtn) authBtn.style.display = 'none'
              if (userInfo) userInfo.style.display = 'flex'
              if (userMenu && typeof userMenu.applyUser === 'function') {
                userMenu.applyUser(json.user)
              }
              return json.user
            }
            listEl.innerHTML = '<p style="padding:16px;text-align:center;opacity:0.6">' + window.t('profile.notLoggedIn') + '</p>'
            return null
          } catch (e) {
            console.error('[my-rooms] auth check failed', e)
            listEl.innerHTML = '<p style="padding:16px;text-align:center;color:#d00">' + window.t('errors.networkError') + '</p>'
            return null
          }
        }

        if (authBtn) {
          authBtn.addEventListener('click', function() {
            window.location.href = '/api/auth/google/login?redirect=' + encodeURIComponent(window.location.pathname)
          })
        }

        const user = await checkAuth()
        if (!user) {
          return
        }

        const tabs = tabButtons.map(function(button) {
          return { status: button.getAttribute('data-status') || 'published', button: button }
        })

        const manager = setupRoomsManager({
          listEl: listEl,
          paginationEl: paginationEl,
          tabs: tabs,
          lang: lang,
          t: function(key) { return window.t(key) },
          pageSize: 10,
          onNotify: function(text, isError) {
            showMessage(text, isError)
          },
          emptyText: window.t('myRooms.empty')
        })

        window.addEventListener('storage', function(event) {
          if (event.key === 'qp_home_refresh' && event.newValue && manager && typeof manager.refresh === 'function') {
            manager.refresh()
          }
        })
      })()
    </script>
  </body>
</html>
