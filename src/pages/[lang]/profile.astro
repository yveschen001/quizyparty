---
import { setupServerI18n } from '../../lib/server-i18n'
import SeoMeta from '../../components/SeoMeta.astro'
import '../../styles/base.css'
import AppHeader from '../../components/layout/AppHeader.astro'

const { lang, serverT } = await setupServerI18n(Astro.params.lang)
const title = serverT('profile.title')
const desc = serverT('profile.desc')

export const prerender = false
const siteOrigin =
  (Astro.site && Astro.site.origin) || import.meta.env.SITE || 'https://quizyparty.com'
const path = Astro.url.pathname
---

<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <SeoMeta lang={lang} title={title} description={desc} path={path} siteOrigin={siteOrigin} />
  </head>
  <body>
    <a href="#main" class="sr-only">{serverT('a11y.skipToContent')}</a>
    <AppHeader lang={lang} serverT={serverT} />
    <main
      id="main"
      class="container"
      style="display:grid;gap:32px;padding-top:32px;padding-bottom:64px"
    >
      <section style="display:grid;gap:16px">
        <div
          style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px"
        >
          <div>
            <h1 class="h1" style="margin:0">{title}</h1>
            <p style="margin:4px 0 0;font-size:0.95rem;opacity:0.7">{serverT('profile.desc')}</p>
          </div>
          <div
            style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"
            role="group"
            aria-label={serverT('profile.stats.scopeLabel')}
          >
            <button
              id="scope-all"
              class="btn btn-primary"
              type="button"
              data-scope="all"
              aria-pressed="true">{serverT('profile.scope.all')}</button
            >
            <button id="scope-30d" class="btn" type="button" data-scope="30d" aria-pressed="false"
              >{serverT('profile.scope.30d')}</button
            >
            <button
              id="open-settings"
              class="btn"
              type="button"
              aria-label={serverT('profile.settings.open')}
              title={serverT('profile.settings.open')}
              aria-controls="settings-modal"
              style="display:inline-flex;align-items:center;gap:6px"
            >
              <span aria-hidden="true">⚙️</span><span class="sr-only">{serverT('profile.settings.open')}</span>
            </button>
          </div>
        </div>
        <div id="stats-message" style="min-height:1.2em;font-size:0.9rem"></div>
        <div
          id="stats-panel"
          class="stats-grid"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px"
        >
          <article
            class="card"
            style="padding:20px;border:1px solid #e5e7eb;border-radius:16px;background:#fff;display:grid;gap:8px"
          >
            <h2 style="margin:0;font-size:0.95rem;opacity:0.65">
              {serverT('profile.stats.totalAnswers')}
            </h2>
            <p id="stats-total" style="margin:0;font-size:1.8rem;font-weight:600">0</p>
          </article>
          <article
            class="card"
            style="padding:20px;border:1px solid #e5e7eb;border-radius:16px;background:#fff;display:grid;gap:8px"
          >
            <h2 style="margin:0;font-size:0.95rem;opacity:0.65">
              {serverT('profile.stats.accuracy')}
            </h2>
            <p id="stats-accuracy" style="margin:0;font-size:1.8rem;font-weight:600">0%</p>
          </article>
          <article
            class="card"
            style="padding:20px;border:1px solid #e5e7eb;border-radius:16px;background:#fff;display:grid;gap:8px"
          >
            <h2 style="margin:0;font-size:0.95rem;opacity:0.65">
              {serverT('profile.stats.points')}
            </h2>
            <p id="stats-points" style="margin:0;font-size:1.8rem;font-weight:600">0</p>
          </article>
          <article
            class="card"
            style="padding:20px;border:1px solid #e5e7eb;border-radius:16px;background:#fff;display:grid;gap:8px"
          >
            <h2 style="margin:0;font-size:0.95rem;opacity:0.65">{serverT('profile.stats.rank')}</h2>
            <p id="stats-rank" style="margin:0;font-size:1.8rem;font-weight:600">—</p>
            <span id="stats-percentile" style="font-size:0.85rem;opacity:0.7"></span>
          </article>
        </div>
      </section>

      <section id="v2-cards" style="display:none;gap:16px">
        <div
          class="grid"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:8px"
        >
          <article class="card" style="display:grid;gap:8px">
            <h3 class="h3" style="margin:0">{serverT('profile.cards.created.title')}</h3>
            <p class="p" style="margin:0;opacity:0.8">{serverT('profile.cards.created.desc')}</p>
            <div>
              <a class="btn btn-primary" href={`/${lang}/rooms/created`}
                >{serverT('common.viewAll')}</a>
            </div>
          </article>
          <article class="card" style="display:grid;gap:8px">
            <h3 class="h3" style="margin:0">{serverT('profile.cards.joined.title')}</h3>
            <p class="p" style="margin:0;opacity:0.8">{serverT('profile.cards.joined.desc')}</p>
            <div>
              <a class="btn btn-primary" href={`/${lang}/rooms/joined`}
                >{serverT('common.viewAll')}</a>
            </div>
          </article>
        </div>
      </section>

      <section id="v1-created" style="display:grid;gap:16px">
        <div
          style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px"
        >
          <h2 class="h2" style="margin:0">{serverT('profile.sections.myRooms')}</h2>
          <a class="btn" href={`/${lang}/create-room`} style="font-size:0.9rem"
            >{serverT('profile.sections.createRoom')}</a
          >
        </div>
        <div
          id="created-tabs"
          role="tablist"
          aria-label={serverT('profile.sections.myRooms')}
          style="display:flex;gap:8px;flex-wrap:wrap"
        >
          <button class="btn btn-primary" data-status="published" type="button" aria-pressed="true"
            >{serverT('myRooms.published')}</button
          >
          <button class="btn" data-status="draft" type="button" aria-pressed="false"
            >{serverT('myRooms.drafts')}</button
          >
        </div>
        <div id="created-message" style="min-height:1.1em;font-size:0.9rem"></div>
        <div id="created-list" style="display:grid;gap:12px"></div>
        <div
          id="created-pagination"
          style="display:none;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px"
        >
        </div>
      </section>

      <section id="v1-joined" style="display:grid;gap:16px">
        <div
          style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px"
        >
          <h2 class="h2" style="margin:0">{serverT('profile.sections.participations')}</h2>
        </div>
        <div id="participations-message" style="min-height:1.1em;font-size:0.9rem"></div>
        <div id="participations-list" style="display:grid;gap:12px"></div>
      </section>
    </main>
    <div
      id="settings-modal"
      style="display:none;position:fixed;inset:0;z-index:60;background:rgba(15,23,42,0.45);align-items:center;justify-content:center;padding:24px"
    >
      <div
        role="dialog"
        aria-modal="true"
        aria-labelledby="settings-title"
        style="width:min(560px,100%);background:#fff;border-radius:16px;padding:20px;display:grid;gap:16px"
      >
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h3 id="settings-title" class="h3" style="margin:0">
            {serverT('profile.settings.title')}
          </h3>
          <button
            id="close-settings"
            class="btn"
            type="button"
            aria-label="{serverT('profile.settings.close')}">✕</button
          >
        </div>
        <div style="display:grid;gap:12px">
          <label for="settings-lang" style="font-weight:600">{serverT('languages.label')}</label>
          <select id="settings-lang" class="tab" style="font-size:0.95rem">
            <option value="en">{serverT('languages.en')}</option>
            <option value="zh-hant">{serverT('languages.zhHant')}</option>
            <option value="zh-hans">{serverT('languages.zhHans')}</option>
            <option value="ja">{serverT('languages.ja')}</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button id="settings-cancel" class="btn" type="button">{serverT('common.cancel')}</button>
          <button id="settings-save" class="btn btn-primary" type="button"
            >{serverT('common.save')}</button
          >
        </div>
      </div>
    </div>
    <script type="module" src="/js/i18n.js"></script>
    <script src="/js/room-templates.js" is:inline></script>
    <script type="module">
      ;(async function () {
        await import('/js/i18n.js')
        const { setupRoomsManager } = await import('/js/rooms-manager.js')
        const lang = document.documentElement.getAttribute('lang') || 'en'
        const featureV2 = import.meta.env && import.meta.env.PUBLIC_FEATURE_UI_V2 !== 'false'
        let fmt = null
        try {
          fmt = await import('/src/utils/format.ts')
        } catch (e) {}
        const profileStatsV1 = true

        const openSettingsBtn = document.getElementById('open-settings')
        const settingsModal = document.getElementById('settings-modal')
        const settingsLang = document.getElementById('settings-lang')
        const settingsCancel = document.getElementById('settings-cancel')
        const settingsClose = document.getElementById('close-settings')
        const settingsSave = document.getElementById('settings-save')
        const statsTotalEl = document.getElementById('stats-total')
        const statsAccuracyEl = document.getElementById('stats-accuracy')
        const statsPointsEl = document.getElementById('stats-points')
        const statsRankEl = document.getElementById('stats-rank')
        const statsPercentileEl = document.getElementById('stats-percentile')
        const statsMessageEl = document.getElementById('stats-message')
        const scopeAllBtn = document.getElementById('scope-all')
        const scope30dBtn = document.getElementById('scope-30d')
        const createdList = document.getElementById('created-list')
        const createdPagination = document.getElementById('created-pagination')
        const createdMessage = document.getElementById('created-message')
        const participationsList = document.getElementById('participations-list')
        const participationsMessage = document.getElementById('participations-message')
        const v2Cards = document.getElementById('v2-cards')
        const v1Created = document.getElementById('v1-created')
        const v1Joined = document.getElementById('v1-joined')

        // V2 卡片入口顯示控制
        if (featureV2) {
          if (v2Cards) v2Cards.style.display = 'grid'
          if (v1Created) v1Created.style.display = 'none'
          if (v1Joined) v1Joined.style.display = 'none'
        } else {
          if (v2Cards) v2Cards.style.display = 'none'
        }

        function showStatsMessage(text, isError) {
          if (!statsMessageEl) return
          if (!text) {
            statsMessageEl.textContent = ''
            return
          }
          statsMessageEl.textContent = text
          statsMessageEl.style.color = isError ? '#d00' : '#059669'
        }

        function showCreatedMessage(text, isError) {
          if (!createdMessage) return
          if (!text) {
            createdMessage.textContent = ''
            return
          }
          createdMessage.textContent = text
          createdMessage.style.color = isError ? '#d00' : '#059669'
        }

        function showParticipationsMessage(text, isError) {
          if (!participationsMessage) return
          if (!text) {
            participationsMessage.textContent = ''
            return
          }
          participationsMessage.textContent = text
          participationsMessage.style.color = isError ? '#d00' : '#059669'
        }

        // Settings modal 行為
        function toggleSettings(open) {
          if (!settingsModal) return
          settingsModal.style.display = open ? 'flex' : 'none'
          if (open) {
            setTimeout(function () {
              if (settingsLang) settingsLang.focus()
            }, 0)
          }
        }
        function computeRedirectPath(targetLang) {
          const url = new URL(window.location.href)
          const segments = url.pathname.split('/').filter(Boolean)
          if (segments.length === 0) segments.push(targetLang)
          else segments[0] = targetLang
          return '/' + segments.join('/') + url.search + url.hash
        }
        if (openSettingsBtn) {
          openSettingsBtn.addEventListener('click', function () {
            if (settingsLang) settingsLang.value = lang
            toggleSettings(true)
          })
        }
        if (settingsCancel)
          settingsCancel.addEventListener('click', function () {
            toggleSettings(false)
          })
        if (settingsClose)
          settingsClose.addEventListener('click', function () {
            toggleSettings(false)
          })
        if (settingsSave) {
          settingsSave.addEventListener('click', function () {
            if (!settingsLang) return
            const target = settingsLang.value || lang
            try {
              window.localStorage.setItem('lang', target)
            } catch {}
            try {
              window.localStorage.setItem('qp_interface_lang', target)
            } catch {}
            try {
              if (window.i18next && typeof window.i18next.changeLanguage === 'function') {
                window.i18next.changeLanguage(target)
              }
            } catch {}
            window.location.href = computeRedirectPath(target)
          })
        }
        // Allow closing modal via Escape and backdrop click
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape') toggleSettings(false)
        })
        if (settingsModal) {
          settingsModal.addEventListener('click', function (e) {
            if (e.target === settingsModal) toggleSettings(false)
          })
        }

        function formatAccuracy(value) {
          if (fmt && fmt.formatPercent) return fmt.formatPercent(value || 0, lang, 1)
          const percent = Math.round((value || 0) * 1000) / 10
          return percent.toFixed(1) + '%'
        }

        function formatNumber(value) {
          if (fmt && fmt.formatNumber) return fmt.formatNumber(value || 0, lang)
          return (value || 0).toLocaleString()
        }

        function formatDate(timestamp) {
          if (fmt && fmt.formatDate) return fmt.formatDate(timestamp, lang, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
          if (!timestamp) return ''
          const date = new Date(timestamp)
          if (!date.getTime()) return ''
          try {
            return date.toLocaleString(lang, {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            })
          } catch (e) {
            return date.toLocaleString()
          }
        }

        function computeScore(correct, total, totalTimeMs) {
          if (total <= 0) return 0
          const accuracy = correct / total
          const maxTime = 15000
          const averageTime = totalTimeMs > 0 ? totalTimeMs / total : maxTime
          const clamped = Math.min(Math.max(averageTime, 0), maxTime)
          const quantityScore = correct * 100
          const accuracyScore = accuracy * 600
          const speedScore = ((maxTime - clamped) / maxTime) * 300
          const totalScore = quantityScore + accuracyScore + Math.max(0, speedScore)
          return Math.round(totalScore)
        }

        async function checkAuth() {
          try {
            const res = await fetch('/api/auth/me', { credentials: 'include' })
            if (!res.ok) {
              showStatsMessage(window.t('profile.notLoggedIn'), true)
              return null
            }
            const json = await res.json()
            if (json && json.authenticated && json.user) {
              return json.user
            }
            showStatsMessage(window.t('profile.notLoggedIn'), true)
            return null
          } catch (e) {
            console.error('[profile] auth check failed', e)
            showStatsMessage(window.t('errors.networkError'), true)
            return null
          }
        }

        const currentUser = await checkAuth()
        if (!currentUser) {
          return
        }

        let statsAll = null
        let historyRecords = []
        let participationsAll = []
        let leaderboardEntries = []
        let createdManager = null
        let currentScope = 'all'

        async function fetchStats() {
          try {
            const res = await fetch(
              '/api/scores/stats?userId=' + encodeURIComponent(currentUser.id),
              { credentials: 'include' },
            )
            if (res.ok) {
              statsAll = await res.json()
            }
          } catch (e) {
            console.error('[profile] fetch stats failed', e)
          }
        }

        async function fetchHistory() {
          try {
            const res = await fetch(
              '/api/scores/history?userId=' + encodeURIComponent(currentUser.id) + '&limit=100',
              { credentials: 'include' },
            )
            if (res.ok) {
              const json = await res.json()
              historyRecords = Array.isArray(json.history) ? json.history : []
            }
          } catch (e) {
            console.error('[profile] fetch history failed', e)
          }
        }

        async function fetchParticipations() {
          try {
            const res = await fetch(
              '/api/scores/rooms?userId=' + encodeURIComponent(currentUser.id) + '&limit=100',
              { credentials: 'include' },
            )
            if (res.ok) {
              const json = await res.json()
              participationsAll = Array.isArray(json.rooms) ? json.rooms : []
            }
          } catch (e) {
            console.error('[profile] fetch participations failed', e)
          }
        }

        async function fetchLeaderboard() {
          try {
            const res = await fetch('/api/scores/leaderboard?limit=200')
            if (res.ok) {
              const json = await res.json()
              leaderboardEntries = Array.isArray(json.leaderboard) ? json.leaderboard : []
            }
          } catch (e) {
            console.error('[profile] fetch leaderboard failed', e)
          }
        }

        await Promise.all([fetchStats(), fetchHistory(), fetchParticipations(), fetchLeaderboard()])

        function findLeaderboardEntry(userId) {
          for (let i = 0; i < leaderboardEntries.length; i += 1) {
            const entry = leaderboardEntries[i]
            if (entry && entry.userId === userId) {
              return { entry: entry, index: i }
            }
          }
          return null
        }

        function computeStatsForScope(scope) {
          const now = Date.now()
          const threshold = now - 30 * 24 * 60 * 60 * 1000
          let totalAnswered = 0
          let totalCorrect = 0
          let totalTime = 0
          let points = 0
          let accuracy = 0
          let rankDisplay = '—'
          let percentileDisplay = ''

          let records = historyRecords
          if (scope === '30d') {
            records = historyRecords.filter(function (record) {
              return record && record.answeredAt >= threshold
            })
          }
          for (let i = 0; i < records.length; i += 1) {
            const record = records[i]
            if (!record) continue
            totalAnswered += 1
            if (record.isCorrect) totalCorrect += 1
            if (typeof record.timeSpentMs === 'number') {
              totalTime += record.timeSpentMs
            }
          }
          if (totalAnswered > 0) {
            accuracy = totalCorrect / totalAnswered
          }
          points = computeScore(totalCorrect, totalAnswered, totalTime)

          if (scope === 'all' && statsAll) {
            totalAnswered =
              typeof statsAll.totalAnswered === 'number' ? statsAll.totalAnswered : totalAnswered
            const totalCorrectAll =
              typeof statsAll.totalCorrect === 'number' ? statsAll.totalCorrect : totalCorrect
            accuracy = totalAnswered > 0 ? totalCorrectAll / totalAnswered : 0
            const entryInfo = findLeaderboardEntry(currentUser.id)
            if (entryInfo) {
              const entry = entryInfo.entry
              points = typeof entry.score === 'number' ? entry.score : points
              const position = entryInfo.index + 1
              const totalPlayers = leaderboardEntries.length
              rankDisplay = '#' + position
              if (totalPlayers > 0) {
                const percentile = Math.round((position / totalPlayers) * 100)
                percentileDisplay = window
                  .t('profile.stats.percentile')
                  .replace('{value}', String(percentile))
              }
            }
          } else if (
            scope === 'all' &&
            statsAll &&
            typeof statsAll.totalCorrect === 'number' &&
            typeof statsAll.totalAnswered === 'number'
          ) {
            const entry = findLeaderboardEntry(currentUser.id)
            if (entry) {
              rankDisplay = '#' + (entry.index + 1)
              const totalPlayers = leaderboardEntries.length
              if (totalPlayers > 0) {
                const percentile = Math.round(((entry.index + 1) / totalPlayers) * 100)
                percentileDisplay = window
                  .t('profile.stats.percentile')
                  .replace('{value}', String(percentile))
              }
            }
          }

          return {
            totalAnswered: totalAnswered,
            accuracy: accuracy,
            points: points,
            rankLabel: rankDisplay,
            percentileLabel: percentileDisplay,
          }
        }

        function renderStats(scope) {
          const stats = computeStatsForScope(scope)
          if (statsTotalEl) statsTotalEl.textContent = formatNumber(stats.totalAnswered)
          if (statsAccuracyEl) statsAccuracyEl.textContent = formatAccuracy(stats.accuracy || 0)
          if (statsPointsEl) statsPointsEl.textContent = formatNumber(stats.points || 0)
          if (statsRankEl) statsRankEl.textContent = stats.rankLabel || '—'
          if (statsPercentileEl) statsPercentileEl.textContent = stats.percentileLabel || ''
        }

        function renderParticipations(scope) {
          if (!participationsList) return
          participationsList.innerHTML =
            '<p style="padding:16px;text-align:center;opacity:0.6">' +
            window.t('room.loading') +
            '</p>'
          const now = Date.now()
          const threshold = now - 30 * 24 * 60 * 60 * 1000
          let items = participationsAll
          if (scope === '30d') {
            items = participationsAll.filter(function (item) {
              return item && item.lastAnsweredAt >= threshold
            })
          }
          if (!items.length) {
            participationsList.innerHTML =
              '<p style="padding:16px;text-align:center;opacity:0.6">' +
              window.t('profile.participations.empty') +
              '</p>'
            return
          }
          participationsList.innerHTML = ''
          for (let i = 0; i < items.length; i += 1) {
            const item = items[i]
            if (!item) continue
            const card = document.createElement('div')
            card.style.display = 'grid'
            card.style.gap = '8px'
            card.style.padding = '16px'
            card.style.border = '1px solid #e5e7eb'
            card.style.borderRadius = '12px'
            card.style.background = '#fff'

            const title = document.createElement('div')
            title.style.display = 'flex'
            title.style.justifyContent = 'space-between'
            title.style.alignItems = 'center'
            title.style.flexWrap = 'wrap'
            title.style.gap = '8px'

            const heading = document.createElement('h3')
            heading.style.margin = '0'
            heading.style.fontSize = '1rem'
            heading.textContent =
              item.roomTitle || window.t('profile.roomIdLabel') + ' ' + item.roomId
            title.appendChild(heading)

            const time = document.createElement('span')
            time.style.fontSize = '0.85rem'
            time.style.opacity = '0.65'
            time.textContent = formatDate(item.lastAnsweredAt)
            title.appendChild(time)

            card.appendChild(title)

            const meta = document.createElement('div')
            meta.style.display = 'flex'
            meta.style.gap = '16px'
            meta.style.flexWrap = 'wrap'
            meta.style.fontSize = '0.9rem'
            meta.style.opacity = '0.75'

            const countSpan = document.createElement('span')
            countSpan.textContent = window
              .t('profile.participations.total')
              .replace('{value}', String(item.totalAnswered || 0))
            meta.appendChild(countSpan)

            const accuracySpan = document.createElement('span')
            const accuracyValue =
              item.totalAnswered > 0 ? Math.round((item.accuracy || 0) * 1000) / 10 : 0
            accuracySpan.textContent = window
              .t('profile.participations.accuracy')
              .replace('{value}', accuracyValue.toFixed(1) + '%')
            meta.appendChild(accuracySpan)

            card.appendChild(meta)

            const actions = document.createElement('div')
            actions.style.display = 'flex'
            actions.style.gap = '8px'
            actions.style.flexWrap = 'wrap'

            const replay = document.createElement('a')
            replay.className = 'btn'
            replay.style.fontSize = '0.85rem'
            replay.href = '/' + lang + '/room/' + encodeURIComponent(item.roomId)
            replay.textContent = window.t('profile.history.playAgain')
            actions.appendChild(replay)

            card.appendChild(actions)
            participationsList.appendChild(card)
          }
        }

        function updateScopeButtons(scope) {
          const buttons = [scopeAllBtn, scope30dBtn]
          for (let i = 0; i < buttons.length; i += 1) {
            const button = buttons[i]
            if (!button) continue
            const targetScope = button.getAttribute('data-scope') || 'all'
            const isActive = targetScope === scope
            if (isActive) {
              button.classList.add('btn-primary')
              button.classList.remove('btn')
              button.setAttribute('aria-pressed', 'true')
            } else {
              button.classList.remove('btn-primary')
              button.classList.add('btn')
              button.setAttribute('aria-pressed', 'false')
            }
          }
        }

        const createdTabsContainer = document.getElementById('created-tabs')
        const createdTabs = createdTabsContainer
          ? Array.prototype.slice
              .call(createdTabsContainer.querySelectorAll('[data-status]'))
              .map(function (button) {
                return { status: button.getAttribute('data-status') || 'published', button: button }
              })
          : []

        if (!featureV2) {
          createdManager = setupRoomsManager({
            listEl: createdList,
            paginationEl: createdPagination,
            tabs: createdTabs,
            lang: lang,
            t: function (key) {
              return window.t(key)
            },
            pageSize: 5,
            onNotify: function (text, isError) {
              showCreatedMessage(text, isError)
            },
            filter: function (template) {
              if (!template || !template.updatedAt) return true
              if (currentScope !== '30d') return true
              const updatedAt = template.updatedAt
              const cutoff = Date.now() - 30 * 24 * 60 * 60 * 1000
              return updatedAt >= cutoff
            },
            emptyText: window.t('profile.created.emptyScope'),
          })
        }

        function applyScope(scope) {
          currentScope = scope
          updateScopeButtons(scope)
          renderStats(scope)
          if (!featureV2) {
            renderParticipations(scope)
            if (createdManager && typeof createdManager.setFilter === 'function') {
              createdManager.setFilter(function (template) {
                if (!template || !template.updatedAt) return scope !== '30d'
                if (scope !== '30d') return true
                const cutoff = Date.now() - 30 * 24 * 60 * 60 * 1000
                return template.updatedAt >= cutoff
              })
            }
          }
        }

        if (scopeAllBtn) {
          scopeAllBtn.addEventListener('click', function () {
            applyScope('all')
          })
        }
        if (scope30dBtn) {
          scope30dBtn.addEventListener('click', function () {
            applyScope('30d')
          })
        }

        renderStats('all')
        if (!featureV2) {
          renderParticipations('all')
        }
        applyScope('all')
      })()
    </script>
  </body>
</html>
