---
import { setupServerI18n } from '../../lib/server-i18n';
import SeoMeta from '../../components/SeoMeta.astro'
import '../../styles/base.css';

const { lang, serverT } = await setupServerI18n(Astro.params.lang);
const title = serverT('profile.sections.participations');
const desc = serverT('profile.desc');

export const prerender = false;
const siteOrigin = (Astro.site && Astro.site.origin) || import.meta.env.SITE || 'https://quizyparty.com'
const path = Astro.url.pathname
---
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <SeoMeta lang={lang} title={title} description={desc} path={path} siteOrigin={siteOrigin} />
  </head>
  <body>
    <a href="#main" class="sr-only">{serverT('a11y.skipToContent')}</a>
    <header class="navbar">
      <div class="container inner">
        <a href={`/${lang}/`}>{serverT('nav.home')}</a>
        <nav style="display:flex;gap:12px;align-items:center">
          <label for="lang-switch" class="sr-only">{serverT('languages.label')}</label>
          <select id="lang-switch" class="tab" style="font-size:0.85rem">
            <option value="en" selected={lang === 'en'}>{serverT('languages.en')}</option>
            <option value="zh-hant" selected={lang === 'zh-hant'}>{serverT('languages.zhHant')}</option>
            <option value="zh-hans" selected={lang === 'zh-hans'}>{serverT('languages.zhHans')}</option>
            <option value="ja" selected={lang === 'ja'}>{serverT('languages.ja')}</option>
            <option value="ko" selected={lang === 'ko'}>{serverT('languages.ko')}</option>
            <option value="de" selected={lang === 'de'}>{serverT('languages.de')}</option>
            <option value="fr" selected={lang === 'fr'}>{serverT('languages.fr')}</option>
          </select>
        </nav>
      </div>
    </header>
    <main id="main" class="container" style="display:grid;gap:16px;padding-top:24px;padding-bottom:48px">
      <h1 class="h1" style="margin:0">{title}</h1>
      <div id="message" style="min-height:1.1em;font-size:0.9rem"></div>
      <div id="list" style="display:grid;gap:12px"></div>
    </main>
    <script type="module" src="/js/i18n.js"></script>
    <script type="module">
      (async function() {
        await import('/js/i18n.js')
        const lang = document.documentElement.getAttribute('lang') || 'en'

        const message = document.getElementById('message')
        const list = document.getElementById('list')
        const langSwitch = document.getElementById('lang-switch')

        function showMessage(text, isError) {
          if (!message) return
          if (!text) {
            message.textContent = ''
            return
          }
          message.textContent = text
          message.style.color = isError ? '#d00' : '#059669'
        }

        function computeRedirectPath(targetLang) {
          const url = new URL(window.location.href)
          const segments = url.pathname.split('/').filter(Boolean)
          if (segments.length === 0) {
            segments.push(targetLang)
          } else {
            segments[0] = targetLang
          }
          return '/' + segments.join('/') + url.search + url.hash
        }

        if (langSwitch) {
          langSwitch.addEventListener('change', function() {
            const target = langSwitch.value || lang
            window.location.href = computeRedirectPath(target)
          })
        }

        async function loadParticipations() {
          if (!list) return
          list.innerHTML = '<p style="padding:16px;text-align:center;opacity:0.6">' + window.t('room.loading') + '</p>'
          try {
            const res = await fetch('/api/scores/rooms?limit=100', { credentials: 'include' })
            if (res.status === 401) {
              showMessage(window.t('profile.notLoggedIn'), true)
              list.innerHTML = ''
              return
            }
            const json = await res.json()
            const items = Array.isArray(json.rooms) ? json.rooms : []
            if (!items.length) {
              list.innerHTML = '<p style="padding:16px;text-align:center;opacity:0.6">' + window.t('profile.participations.empty') + '</p>'
              return
            }
            list.innerHTML = ''
            for (let i = 0; i < items.length; i += 1) {
              const item = items[i]
              const card = document.createElement('div')
              card.className = 'card'
              card.style.padding = '16px'
              card.style.display = 'grid'
              card.style.gap = '6px'
              const title = document.createElement('div')
              title.style.fontWeight = '700'
              title.textContent = (item && item.roomTitle) || window.t('questionSets.untitled')
              card.appendChild(title)
              const meta = document.createElement('div')
              meta.style.fontSize = '0.9rem'
              meta.style.opacity = '0.75'
              const total = document.createElement('span')
              total.textContent = window.t('profile.participations.total').replace('{value}', String(item.totalAnswered || 0))
              meta.appendChild(total)
              const sep = document.createElement('span')
              sep.textContent = ' Â· '
              meta.appendChild(sep)
              const accuracySpan = document.createElement('span')
              const accuracyValue = item.totalAnswered > 0 ? Math.round((item.accuracy || 0) * 1000) / 10 : 0
              accuracySpan.textContent = window.t('profile.participations.accuracy').replace('{value}', accuracyValue.toFixed(1) + '%')
              meta.appendChild(accuracySpan)
              card.appendChild(meta)
              const actions = document.createElement('div')
              actions.style.display = 'flex'
              actions.style.gap = '8px'
              actions.style.flexWrap = 'wrap'
              const replay = document.createElement('a')
              replay.className = 'btn'
              replay.style.fontSize = '0.85rem'
              replay.href = '/' + lang + '/room/' + encodeURIComponent(item.roomId)
              replay.textContent = window.t('profile.history.playAgain')
              actions.appendChild(replay)
              card.appendChild(actions)
              list.appendChild(card)
            }
          } catch (e) {
            console.error('[my-participations] load failed', e)
            showMessage(window.t('errors.networkError'), true)
          }
        }

        await loadParticipations()
      })()
    </script>
  </body>
</html>


